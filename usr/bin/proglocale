#! /bin/sh 

# Uncomment for debugging purposes:
#set -x

# Copyright (C) 2015 by Paul Seelig <wmlive@rumbero.org>

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

PROGENVDEFAULTS=/etc/default/progfetch

if [ -s ${PROGENVDEFAULTS} ]
then
   . ${PROGENVDEFAULTS}
fi

if [ "$(uname -m)" = "x86_64" ]
then
    CPUTYPE="x86_64"
else
    CPUTYPE="i686"
fi

SYSENVLANG="$(grep ^LANG= /etc/default/locale | tr -d \" | cut -d= -f2 | cut -d. -f1)"
USERENVLANG="$(echo $LANG | tr -d \" | cut -d= -f2 | cut -d. -f1)"

LIVESESSION="$(mount | grep -c ^'aufs on / type aufs ')"

if [ "${LIVESESSION}" = "1" ]
then
    PROGBASEDIR="/lib/live/mount/medium/custom"
else
    PROGBASEDIR="/opt/linux-${CPUTYPE}"
fi

if [ "${INSTALLPROGS}" != "" ]
then
    for PROGCHOICE in ${INSTALLPROGS}
    do
        if [ "${PROGCHOICE}" = "palemoon" ]
        then
            PROGUSERDIR="${HOME}/.moonchild_productions/palemoon"
        elif [ "${PROGCHOICE}" = "thunderbird" ]
        then
            PROGUSERDIR="${HOME}/.thunderbird"
        elif [ "${PROGCHOICE}" = "firefox" ]
        then
            PROGUSERDIR="${HOME}/.mozilla/firefox"
        elif [ "${PROGCHOICE}" = "FossaMail" ]
        then
            PROGUSERDIR="${HOME}/.fossamail"
        else
            continue
        fi

        [ -d "${PROGUSERDIR}" ] || continue

        USERPROFILE="$(grep ^Path= ${PROGUSERDIR}/profiles.ini | cut -d= -f2)"
        USEREXTDIR="${PROGUSERDIR}/${USERPROFILE}/extensions"

        PROGLANGSDIR="${PROGBASEDIR}/${PROGCHOICE}/langpacks"

        if [ -d "${PROGLANGSDIR}" ]
        then
            PROGLOCALEDIR=$(find "${PROGLANGSDIR}" -type d -name "[1-9]*" | sort -g | tail -n 1)
        fi

        if [ -d "${PROGLOCALEDIR}" ] && [ -d "${USEREXTDIR}" ]
        then
            for ENVLANG in ${SYSENVLANG} ${USERENVLANG}
            do
                LOCALE=$(echo "${ENVLANG}" | tr _ -) 
                XPIFILE=$(find "${PROGLOCALEDIR}" -name "langpack-${LOCALE}@*.xpi" -type f)
                if [ "${XPIFILE}" != "" ]
                then
                    [ -s "${USEREXTDIR}/$(basename ${XPIFILE})" ] || cp "${XPIFILE}" "${USEREXTDIR}"
                else
                    BASELOCALE="$(echo "${LOCALE}" | cut -d- -f1)"
                    for XPIFILE in $(find "${PROGLOCALEDIR}" -name "langpack-${BASELOCALE}*.xpi" -type f)
                    do
                        [ -s "${USEREXTDIR}/$(basename ${XPIFILE})" ] || cp "${XPIFILE}" "${USEREXTDIR}"
                    done
                fi
            done
        fi
    done
fi

