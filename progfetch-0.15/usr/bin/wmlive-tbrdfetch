#!/bin/sh
#set -x

# Copyright (C) 2015 by Paul Seelig <wmlive@rumbero.org>

# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.

# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.

# You should have received a copy of the GNU General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.

GXMSG="/usr/bin/gxmessage -center -wrap -name $(basename "${0}")"

notauthorized ()
{
${GXMSG} -buttons "" -title "Sorry, only root can do this" -file - << EOFSORRY

    Installation of third party software requires root permissions
    or explicit membership in the sudo group for authorized users.
EOFSORRY
}

if [ -x /usr/bin/gxmessage ] && [ "$DISPLAY" != "" ]
then
    $GXMSG -buttons "Try FossaMail:3,Get Thunderbird:2,Cancel:4" -title "Try FossaMail instead" -file - << EOF

    Please note that Thunderbird has been replaced by FossaMail
    as the standard mail program in Window Maker Live. For this 
    reason, Thunderbird has not been included with the default 
    installation and needs to be downloaded first.

               Try FossaMail or download Thunderbird instead?
EOF
    EXITSTATUS="${?}"

    if [ "$EXITSTATUS" = "2" ]
    then
        if [ "$(/usr/bin/id -u)" != "1000" ]
        then
            notauthorized; exec "${0}"
        else
            roxterm --title=tbrdfetch --separate --disable-sm --name=progfetch -e sudo /usr/sbin/tbrdfetch
        fi
    elif [ "$EXITSTATUS" = "3" ]
    then
        if [ "$(ps -ef | grep -c "[w]mlive-progfetch")" = "0" ]
        then
            /opt/FossaMail/FossaMail >/dev/null 2>&1 &
        elif [ "$(/usr/bin/id -u)" = "1000" ]
        then
            roxterm --title=fsmlfetch --separate --disable-sm --name=progfetch -e sudo /usr/sbin/fsmlfetch
        elif [ "$(/usr/bin/id -u)" != "0" ]
        then
            notauthorized; exec "${0}"
        fi
    elif [ "$EXITSTATUS" = "4" ]
    then
        exit 0
    fi
else
    echo "Can't open display, thus quitting ..."
fi
